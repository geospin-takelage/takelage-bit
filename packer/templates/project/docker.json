{
  "variables": {
    "ansible_connection": "docker",
    "ansible_environment": "{{ ansible_environment }}",
    "ansible_host": "{{ user `image_repo` }}",
    "ansible_playbook": "{{ ansible_playbook }}",
    "base_repo": "{{ base_repo }}",
    "base_tag": "{{ base_tag }}",
    "base_user": "{{ base_user }}",
    "image_repo": "{{ image_repo }}",
    "image_tag": "{{ image_tag }}",
    "local_user": "{{ local_user }}"
  },
  "builders":[
    {
      "type": "docker",
      "image": "{{ user `base_user` }}/{{ user `base_repo` }}:{{ user `base_tag` }}",
      "pull": false,
      "export_path": "images/{{ user `image_repo` }}-{{ user `image_tag` }}.tar",
      "run_command": [ "-d", "-i", "-t", "--privileged", "--name", "{{user `image_repo`}}", "{{.Image}}", "/lib/systemd/systemd" ]
    }
  ],
  "provisioners":
  [
    {
      "type": "ansible",
      "user": "root",
      "playbook_file": "../ansible/{{ user `ansible_playbook` }}",
      "groups": [ "all", "private", "users", "{{ user `ansible_environment` }}"],
      "ansible_env_vars" : [
        "ANSIBLE_HOST_KEY_CHECKING=False",
        "ANSIBLE_SSH_ARGS='-v -o ControlMaster=auto -o ControlPersist=15m'"
      ],
      "extra_arguments": [
        "-vvv",
        "--extra-vars",
        "ansible_host={{ user `image_repo` }} ansible_connection={{ user `ansible_connection` }}"
        ]
    }
  ],
  "post-processors": [
    [
      {
        "type": "docker-import",
        "repository": "{{ user `local_user` }}/{{ user `image_repo` }}",
        "tag": "{{ user `image_tag` }}",
        "changes": [
          "CMD [\"/lib/systemd/systemd\"]",
          "ENV DEBIAN_FRONTEND=noninteractive",
          "ENV LANG=en_US.UTF-8",
          "ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
          "WORKDIR /root"
        ]
      }
    ]
  ]
}
